<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>後端連線自檢</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="./xlsx_loader.js"></script>
  <script src="./config.js"></script>
  <script src="./api.js"></script>
  <style>
    .box{padding:16px;max-width:900px;margin:0 auto;}
    pre{white-space:pre-wrap;word-break:break-word;background:#f6f6f6;padding:12px;border-radius:12px;}
    .ok{color:#0a7;}
    .bad{color:#c00;}
    .btn{padding:10px 14px;border-radius:999px;border:1px solid #ddd;background:#fff;}
  </style>
</head>
<body>
  <div class="box">
    <h1>後端連線自檢</h1>
    <p>用來快速確認：EXEC_URL 是否正確、Web App 權限是否為 Anyone、以及 export/update 是否可用。</p>
    <p><b>EXEC_URL：</b> <span id="u"></span></p>
    <p><button class="btn" id="run">開始測試</button></p>
    <div id="out"></div>
  </div>
<script>
  const cfg = window.TRIP_CONFIG || {};
  const $ = (sel)=>document.querySelector(sel);
  const out = (id, ok, obj)=>{
    const el = $("#"+id);
    el.className = ok ? "ok" : "bad";
    el.querySelector("pre").textContent = JSON.stringify(obj, null, 2);
  };

  function showExec(){
    $("#exec").textContent = cfg.EXEC_URL || "(missing)";
  }

  async function run(){
    $("#btn").disabled = true;
    try{
      // meta
      const m = await TripAPI.meta();
      out("meta", true, m);

      // export（只顯示長度，避免畫面太大）
      const ex = await TripAPI.exportXlsx();
      out("export", true, { ok:true, generated_at: ex.generated_at, bytes: ex.b64 ? Math.floor(ex.b64.length*3/4) : 0 });

      // trips: add -> update -> delete（用測試資料，不會影響你原本資料）
      const testName = "TEST_" + Date.now();
      const addRes = await TripAPI.add("trips", { 城市:"測試城市", 項目類型:"測試", 必去/備選:"備選", 名稱:testName, 日期:"" });
      out("add", true, addRes);

      const id = addRes.id || addRes.trip_id;
      const updRes = await TripAPI.update("trips", id, { 日期: "2025-12-25" });
      out("update", true, updRes);

      const delRes = await TripAPI.del("trips", id);
      out("delete", true, delRes);

    }catch(err){
      const info = { ok:false, error: String(err && err.message ? err.message : err), url: err && err.url ? err.url : undefined, code: err && err.code ? err.code : undefined };
      // 依序填入第一個尚未成功的區塊
      const ids = ["meta","export","add","update","delete"];
      for (const id of ids){
        const el = $("#"+id);
        if (!el.classList.contains("ok")){
          out(id, false, info);
          break;
        }
      }
    }finally{
      $("#btn").disabled = false;
    }
  }

  showExec();
  $("#btn").addEventListener("click", run);
</script>
</body>
</html>
